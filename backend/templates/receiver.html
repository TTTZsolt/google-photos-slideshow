<!DOCTYPE html>
<html>

<head>
    <title>B2 Slideshow Receiver</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            overflow: hidden;
        }

        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 2.0s ease-in-out;
            opacity: 0;
        }

        .active {
            opacity: 1;
        }

        .filename-overlay {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            text-align: center;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transition: opacity 1.0s ease-in-out;
            opacity: 0;
            pointer-events: none;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filename-visible {
            opacity: 1;
        }

        .music-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 200;
            display: flex;
            gap: 10px;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        .music-controls:hover {
            opacity: 1;
        }

        .music-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(30, 215, 96, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .music-btn:hover {
            background: rgba(30, 215, 96, 1);
            transform: scale(1.1);
        }

        .music-btn:active {
            transform: scale(0.95);
        }

        .music-status {
            position: absolute;
            bottom: 140px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .music-status.visible {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="img1" class="image-container"></div>
    <div id="img2" class="image-container"></div>
    <div id="filename" class="filename-overlay"></div>

    <!-- YouTube Player (Hidden) -->
    <div id="youtubePlayer" style="display: none;"></div>

    <!-- Music Controls Overlay -->
    <div id="musicControls" class="music-controls" style="display: none;">
        <button id="playPauseBtn" class="music-btn" onclick="togglePlayback()">▶</button>
    </div>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        let currentImg = 1;
        let interval = 20000;
        let lastUrl = "";

        async function updateImage() {
            try {
                const response = await fetch('/slideshow/current-image');
                if (!response.ok) return;
                const data = await response.json();

                const filenameEl = document.getElementById('filename');
                if (data.show_filename && data.filename) {
                    filenameEl.textContent = data.filename;
                    filenameEl.classList.add('filename-visible');
                } else {
                    filenameEl.classList.remove('filename-visible');
                }

                if (data.url && data.url !== lastUrl) {
                    lastUrl = data.url;
                    const nextId = currentImg === 1 ? 'img2' : 'img1';
                    const currId = currentImg === 1 ? 'img1' : 'img2';

                    const nextEl = document.getElementById(nextId);
                    const currEl = document.getElementById(currId);

                    // Preload next image
                    const img = new Image();
                    img.src = data.url;
                    img.onload = () => {
                        // Switch background and transition
                        nextEl.style.backgroundImage = `url('${data.url}')`;
                        nextEl.classList.add('active');
                        currEl.classList.remove('active');
                        currentImg = currentImg === 1 ? 2 : 1;
                    };
                }

                if (data.interval) {
                    interval = data.interval * 1000;
                }
            } catch (e) {
                console.error("Receiver error:", e);
            }
        }

        // Initial check
        updateImage();

        // Loop for polling
        // We poll more frequently than the interval to catch the update as soon as it's ready
        setInterval(updateImage, 3000);

        // ========== YOUTUBE IFRAME API ==========
        let player = null;
        let isPlaying = false;
        let currentPlaylistId = null;
        let musicEnabled = false;

        function onYouTubeIframeAPIReady() {
            console.log('YouTube API Ready');
            initializeYouTube();
        }

        async function initializeYouTube() {
            try {
                // Get Music config
                const configRes = await fetch('/music/config');
                const config = await configRes.json();

                musicEnabled = config.music_enabled;
                currentPlaylistId = config.youtube_playlist_id;

                if (!currentPlaylistId) {
                    console.log('No playlist configured');
                    return;
                }

                player = new YT.Player('youtubePlayer', {
                    height: '0',
                    width: '0',
                    playerVars: {
                        'listType': 'playlist',
                        'list': currentPlaylistId,
                        'autoplay': musicEnabled ? 1 : 0,
                        'controls': 0,
                        'loop': 1,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });

            } catch (error) {
                console.error('YouTube initialization failed:', error);
            }
        }

        function onPlayerReady(event) {
            console.log('YouTube Player Ready');
            event.target.setVolume(50); // Default volume
            if (musicEnabled) {
                event.target.playVideo();
                document.getElementById('musicControls').style.display = 'flex';
            }
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                updatePlayPauseButton();
                // showMusicStatus('Playing', false);
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                updatePlayPauseButton();
            }
        }

        function onPlayerError(event) {
            console.error('YouTube Player Error:', event.data);
            // showMusicStatus('Playback Error', true);
        }

        function togglePlayback() {
            if (!player) return;
            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '⏸' : '▶';
        }

        // Check for Music config changes periodically
        setInterval(async () => {
            try {
                const configRes = await fetch('/music/config');
                const config = await configRes.json();

                // Update Volume
                if (player && typeof player.setVolume === 'function') {
                    player.setVolume(config.volume);
                }

                // Handle Enable/Disable
                if (musicEnabled !== config.music_enabled) {
                    musicEnabled = config.music_enabled;
                    if (musicEnabled) {
                        if (player) player.playVideo();
                        document.getElementById('musicControls').style.display = 'flex';
                    } else {
                        if (player) player.pauseVideo();
                        document.getElementById('musicControls').style.display = 'none';
                    }
                }

                // Handle Playlist Change
                if (config.youtube_playlist_id && config.youtube_playlist_id !== currentPlaylistId) {
                    currentPlaylistId = config.youtube_playlist_id;
                    if (player) {
                        player.loadPlaylist({
                            list: currentPlaylistId,
                            listType: 'playlist'
                        });
                    } else {
                        initializeYouTube();
                    }
                }
            } catch (e) {
                console.error('Config check error:', e);
            }
        }, 5000);
    </script>
</body>

</html>