<!DOCTYPE html>
<html>

<head>
    <title>B2 Slideshow Receiver</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            overflow: hidden;
        }

        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 2.0s ease-in-out;
            opacity: 0;
        }

        .active {
            opacity: 1;
        }

        .filename-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 20px 20px 20px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transition: opacity 1.0s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }

        .filename-visible {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="img1" class="image-container"></div>
    <div id="img2" class="image-container"></div>
    <div id="filename" class="filename-overlay"></div>

    <script>
        let currentImg = 1;
        let interval = 20000;
        let lastUrl = "";

        async function updateImage() {
            try {
                const response = await fetch('/slideshow/current-image');
                if (!response.ok) return;
                const data = await response.json();

                const filenameEl = document.getElementById('filename');
                if (data.show_filename && data.filename) {
                    filenameEl.textContent = data.filename;
                    filenameEl.classList.add('filename-visible');
                } else {
                    filenameEl.classList.remove('filename-visible');
                }

                if (data.url && data.url !== lastUrl) {
                    lastUrl = data.url;
                    const nextId = currentImg === 1 ? 'img2' : 'img1';
                    const currId = currentImg === 1 ? 'img1' : 'img2';

                    const nextEl = document.getElementById(nextId);
                    const currEl = document.getElementById(currId);

                    // Preload next image
                    const img = new Image();
                    img.src = data.url;
                    img.onload = () => {
                        // Switch background and transition
                        nextEl.style.backgroundImage = `url('${data.url}')`;
                        nextEl.classList.add('active');
                        currEl.classList.remove('active');
                        currentImg = currentImg === 1 ? 2 : 1;
                    };
                }

                if (data.interval) {
                    interval = data.interval * 1000;
                }
            } catch (e) {
                console.error("Receiver error:", e);
            }
        }

        // Initial check
        updateImage();

        // Loop for polling
        // We poll more frequently than the interval to catch the update as soon as it's ready
        setInterval(updateImage, 3000);
    </script>
</body>

</html>