<!DOCTYPE html>
<html>

<head>
    <title>B2 Slideshow Receiver</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            overflow: hidden;
        }

        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 2.0s ease-in-out;
            opacity: 0;
        }

        .active {
            opacity: 1;
        }

        .filename-overlay {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            text-align: center;
            color: rgba(255, 255, 255, 0.95);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transition: opacity 1.0s ease-in-out;
            opacity: 0;
            pointer-events: none;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filename-visible {
            opacity: 1;
        }

        .music-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 200;
            display: flex;
            gap: 10px;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        .music-controls:hover {
            opacity: 1;
        }

        .music-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(30, 215, 96, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .music-btn:hover {
            background: rgba(30, 215, 96, 1);
            transform: scale(1.1);
        }

        .music-btn:active {
            transform: scale(0.95);
        }

        .music-status {
            position: absolute;
            bottom: 140px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .music-status.visible {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="img1" class="image-container"></div>
    <div id="img2" class="image-container"></div>
    <div id="filename" class="filename-overlay"></div>

    <!-- Spotify Music Controls -->
    <div id="musicStatus" class="music-status"></div>
    <div id="musicControls" class="music-controls" style="display: none;">
        <button id="playPauseBtn" class="music-btn" onclick="togglePlayback()">▶</button>
    </div>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script>
        let currentImg = 1;
        let interval = 20000;
        let lastUrl = "";

        async function updateImage() {
            try {
                const response = await fetch('/slideshow/current-image');
                if (!response.ok) return;
                const data = await response.json();

                const filenameEl = document.getElementById('filename');
                if (data.show_filename && data.filename) {
                    filenameEl.textContent = data.filename;
                    filenameEl.classList.add('filename-visible');
                } else {
                    filenameEl.classList.remove('filename-visible');
                }

                if (data.url && data.url !== lastUrl) {
                    lastUrl = data.url;
                    const nextId = currentImg === 1 ? 'img2' : 'img1';
                    const currId = currentImg === 1 ? 'img1' : 'img2';

                    const nextEl = document.getElementById(nextId);
                    const currEl = document.getElementById(currId);

                    // Preload next image
                    const img = new Image();
                    img.src = data.url;
                    img.onload = () => {
                        // Switch background and transition
                        nextEl.style.backgroundImage = `url('${data.url}')`;
                        nextEl.classList.add('active');
                        currEl.classList.remove('active');
                        currentImg = currentImg === 1 ? 2 : 1;
                    };
                }

                if (data.interval) {
                    interval = data.interval * 1000;
                }
            } catch (e) {
                console.error("Receiver error:", e);
            }
        }

        // Initial check
        updateImage();

        // Loop for polling
        // We poll more frequently than the interval to catch the update as soon as it's ready
        setInterval(updateImage, 3000);

        // ========== SPOTIFY WEB PLAYBACK SDK ==========
        let spotifyPlayer = null;
        let deviceId = null;
        let isPlaying = false;
        let currentPlaylistUri = null;

        window.onSpotifyWebPlaybackSDKReady = () => {
            initializeSpotify();
        };

        async function initializeSpotify() {
            try {
                // Get Spotify config
                const configRes = await fetch('/spotify/config');
                const config = await configRes.json();

                if (!config.authenticated || !config.music_enabled) {
                    console.log('Spotify not authenticated or music disabled');
                    return;
                }

                // Get access token
                const tokenRes = await fetch('/spotify/token');
                const tokenData = await tokenRes.json();

                // Initialize player
                spotifyPlayer = new Spotify.Player({
                    name: 'B2 Slideshow Receiver',
                    getOAuthToken: cb => { cb(tokenData.access_token); },
                    volume: 0.5
                });

                // Error handling
                spotifyPlayer.addListener('initialization_error', ({ message }) => {
                    console.error('Spotify init error:', message);
                });
                spotifyPlayer.addListener('authentication_error', ({ message }) => {
                    console.error('Spotify auth error:', message);
                    showMusicStatus('Auth Error', true);
                });
                spotifyPlayer.addListener('account_error', ({ message }) => {
                    console.error('Spotify account error:', message);
                    showMusicStatus('Premium Required', true);
                });

                // Ready
                spotifyPlayer.addListener('ready', ({ device_id }) => {
                    console.log('Spotify Ready with Device ID', device_id);
                    deviceId = device_id;
                    document.getElementById('musicControls').style.display = 'flex';

                    // Auto-start playback if playlist is selected
                    if (config.selected_playlist_uri) {
                        currentPlaylistUri = config.selected_playlist_uri;
                        startPlayback();
                    }
                });

                // Player state changed
                spotifyPlayer.addListener('player_state_changed', state => {
                    if (state) {
                        isPlaying = !state.paused;
                        updatePlayPauseButton();
                    }
                });

                // Connect to the player
                spotifyPlayer.connect();

            } catch (error) {
                console.error('Spotify initialization failed:', error);
            }
        }

        async function startPlayback() {
            if (!deviceId || !currentPlaylistUri) return;

            try {
                const tokenRes = await fetch('/spotify/token');
                const tokenData = await tokenRes.json();

                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenData.access_token}`
                    },
                    body: JSON.stringify({
                        context_uri: currentPlaylistUri,
                        position_ms: 0
                    })
                });

                isPlaying = true;
                updatePlayPauseButton();
                showMusicStatus('Playing', false);
            } catch (error) {
                console.error('Failed to start playback:', error);
                showMusicStatus('Playback Error', true);
            }
        }

        async function togglePlayback() {
            if (!spotifyPlayer) return;

            try {
                await spotifyPlayer.togglePlay();
            } catch (error) {
                console.error('Toggle playback error:', error);
            }
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '⏸' : '▶';
        }

        function showMusicStatus(message, isError) {
            const statusEl = document.getElementById('musicStatus');
            statusEl.textContent = message;
            statusEl.style.color = isError ? '#ff6b6b' : 'white';
            statusEl.classList.add('visible');
            setTimeout(() => {
                statusEl.classList.remove('visible');
            }, 3000);
        }

        // Check for Spotify config changes periodically
        setInterval(async () => {
            try {
                const configRes = await fetch('/spotify/config');
                const config = await configRes.json();

                // If music was disabled, pause
                if (!config.music_enabled && isPlaying && spotifyPlayer) {
                    await spotifyPlayer.pause();
                }

                // If playlist changed, restart playback
                if (config.selected_playlist_uri && config.selected_playlist_uri !== currentPlaylistUri) {
                    currentPlaylistUri = config.selected_playlist_uri;
                    if (spotifyPlayer && deviceId) {
                        await startPlayback();
                    }
                }
            } catch (e) {
                console.error('Config check error:', e);
            }
        }, 5000);
    </script>
</body>

</html>